<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="./js/vue.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="./css/ele.css">
    <style type="text/css">

        body, ul, li, h1, h2, h3, h4, h5, h6, p, form, dl, dt, dd {
            margin: 0px;
            padding: 0px;
            font-size: 12px;
            font-weight: normal;
        }

        ul {
            list-style: none;
        }

        img {
            border-style: none;
        }

        * {

        }

        /*body,#app{*/
        /*  width: 100%;*/
        /*  height: 100%;*/
        /*}*/
        #app {
            text-align: center;
            padding: 20px;
            background-color: #222e42;
            color: #ffffff;
        }

        .card {
            background-color: #2b384f;
            margin: 10px;
        }

        .card-title {
            background-color: #324b75;
            height: 40px;
            line-height: 40px;
            border-radius: 3%;
            font-size: 16px;
            font-weight: 400;
        }

        .dev-item {
            width: 100%;
            margin: 10px 0px;

            display: flex;
        }

        /*左侧设备信息*/

        .host-info-box {
            /*flex: 1;*/
            padding: 10px;
            display: flex;
            flex-direction: column;
            width: 260px;
        }

        .dev-info-box {
            flex: 1;
            padding: 10px;
        }

        .dev-info-box .box-item {
            margin-top: 15px;
        }


        .field-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #33425d;
        }

        .field-title {

            font-weight: 600;
            font-size: 14px;
            padding: 3px;
            color: #f2dc58;
            border-radius: 30%;

        }

        .field-value {
            color: #5ce1ad;
            font-size: 14px;
            padding: 3px;
            margin-left: 20px;
        }

        /*环形图表*/
        .dev-circle-chart {
            display: flex;

        }

        .dev-circle-chart .circle-item {
            flex: 1;

        }


        .dev-circle-chart .speed{
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 17px;
            width: 90px;
            margin: 30px;
        }
        .dev-circle-chart .up{
            color: magenta;
        }
        .dev-circle-chart .down{
            color: yellow;
        }
        .dev-circle-chart .circle-item .el-progress__text {

            color: #fff;
        }

        .dev-circle-chart .circle-item span {
            display: block;
            margin: 10px;
            color: #5ce1ad;
        }


        /*网络信息*/
        .dev-network-box {
            display: flex;
            flex-flow: wrap;
            justify-content: space-between;
        }

        .dev-network-box .network-item {
            width: 200px;
            padding: 10px;
            background-color: #2b384f;
            border: 1px solid #305d5e;
            margin-top: 15px;
        }

        .dev-network-box .network-item .net-title {

            background-color: #324b75;
            font-size: 19px;
            margin-bottom: 10px;
            color: #fcfdfd;
        }

        .dev-network-box .network-item .net-field {

            font-size: 15px;
            color: #5ce1ad;

        }

        .dev-network-box .network-item span {
            display: block;
            font-size: 15px;
        }


        /*网卡信息*/

        .dev-net-interface-box {
            display: flex;
            padding: 10px;
            flex-flow: wrap;
            justify-content: space-around;

        }

        .dev-net-interface-box .net-interface-item .net-title {
            background-color: #324b75;
            font-size: 19px;
            color: #fcfdfd;

        }

        .dev-net-interface-box .net-interface-item span {
            display: block;
            font-size: 15px;
        }

        .dev-net-interface-box .net-interface-item .net-interface-arr {
            display: flex;

        }

        .dev-net-interface-box .net-interface-item .net-interface-arr .net-interface-arr-item {

            margin: 10px;

        }


        /*悬浮按钮*/
        .float-btn {
            position: fixed;
            right: 50px;
            bottom: 50px;
            display: flex;
            flex-direction: column;
        }


        .float-btn .show-txt {
            height: 80px;
            width: 80px;
            border-radius: 50%;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;

            color: #fff;
            text-align: center;
            -webkit-transition: opacity .3s ease-in-out;
            transition: opacity .3s ease-in-out;

            display: flex;
            opacity: 70;
            background-color: #59a0ff;
        }

    </style>

    <!-- 引入组件库 -->
    <script type="text/javascript" src="./js/ele.js"></script>


</head>
<body>
<div id="app">
    <div class="dev-item" v-for="(item, i) in devList">

        <!--
          左右两部分
        -->
        <div class="host-info-box card">


            <div class="card-title">设备信息 - {{item.osInfo.hostname}}</div>
            <img :src="item.osInfo.platform=='linux' ? './img/linux.jpg' : './img/win.webp' ">
            <div class="field-item" v-for="(value,key) in item.osInfo">
                <span class="field-title">{{dataMap(key)}}</span>
                <span class="field-value">{{key === 'uptime' ? formatTime(value) : value}}</span>
            </div>
            <div class="field-item" v-for="(value,key) in item.ipInfo">
                <span class="field-title" v-if="value">{{dataMap(key)}}</span>
                <span class="field-value" v-if="value">{{key === 'uptime' ? formatTime(value) : value}}</span>
            </div>
            <div v-if="!item.ipInfo">
                暂无ip信息
            </div>
        </div>

        <!--
               上下两个盒子
         -->
        <div class="dev-info-box card">


            <div class="box-item">
                <div class="card-title">图表 - {{item.osInfo.hostname}}</div>
                <div class="dev-circle-chart">

                    <div class="circle-item">
                        <span>cpu</span>
                        <el-progress type="circle" :percentage="item.cpuInfo.cpuUsage"
                                     :color="getStatus(item.cpuInfo.cpuUsage)"></el-progress>
                        <span>{{item.cpuInfo.cpuCount}}核心 / {{item.osInfo.arch}}</span>
                        <span>{{item.cpuInfo.cpuModel}}</span>
                    </div>

                    <div class="circle-item">
                        <span>磁盘</span>
                        <el-progress type="circle" :percentage="item.driveInfo.usedPercentage"
                                     :color="getStatus(item.driveInfo.usedPercentage)"></el-progress>
                        <span>{{item.driveInfo.usedGb}}GB/{{item.driveInfo.totalGb}}GB</span>
                    </div>
                    <div class="circle-item">
                        <span>内存</span>
                        <el-progress type="circle" :percentage="item.memInfo.usedMemPercentage"
                                     :color="getStatus(item.memInfo.usedMemPercentage)"></el-progress>
                        <span>{{ formatMen(item.memInfo.usedMemMb) }}/{{formatMen(item.memInfo.totalMemMb)}}</span>
                    </div>

                    <div class="speed down" v-if="item.netstatInfo.total">
                        <span>↓ {{ formatNetSpeed(item.netstatInfo.total.inputMb) }}</span>


                    </div>
                    <div class="speed up"  v-if="item.netstatInfo.total">
                         <span>↑ {{ formatNetSpeed(item.netstatInfo.total.outputMb) }}</span>
                    </div>
                </div>
            </div>


            <div class="box-item">
                <div v-if="item.netstatInfo.total!=null" class="card-title">网络信息 - {{item.osInfo.hostname}}</div>
                <div class="dev-network-box">
                    <div class="network-item" v-for="(netValue,netKey) in item.netstatInfo">
                        <!--网卡名称-->
                        <span class="net-title">{{netKey}}</span>
                        <!--上传下载详情-->
                        <span class="net-field">↓ {{ formatNetSpeed(netValue.inputMb) }}</span>
                        <span class="net-field">↑ {{ formatNetSpeed(netValue.outputMb) }}</span>
                    </div>

                </div>
            </div>


            <div class="box-item">
                <div class="card-title">网卡信息 - {{item.osInfo.hostname}}</div>
                <div class="dev-net-interface-box">
                    <div class="net-interface-item" v-for="(netValue,netKey) in item.netInterface">
                        <!--网卡名称-->
                        <span class="net-title">{{netKey}}</span>

                        <div class="net-interface-arr">
                            <div class="net-interface-arr-item" v-for="interfaceItem in netValue">

                                <div class="field-item" v-for="(value,key) in interfaceItem">
                                    <span class="field-title">{{dataMap(key)}}</span>
                                    <span class="field-value" @click="copy(value)">{{value}}</span>
                                </div>
                            </div>
                        </div>


                    </div>

                </div>
            </div>


        </div>

    </div>

    <div class="float-btn">
        <span class="show-txt" @click="showIpv6=!showIpv6">{{showIpv6?'IPv4+IPv6':'IPv4'}}</span>
    </div>

</div>


</body>
<script type="text/javascript">

    const ws = new WebSocket("ws://10.0.8.1:6080?token=abcdef&type=view&endpointName=bb");
    new Vue({
        el: '#app',
        data: function () {
            return {
                devList: [

                    {
                        "cpuInfo": {
                            "cpuUsage": 14.63,
                            "cpuCount": 2,
                            "cpuModel": "Intel(R) Celeron(R) CPU  J1800  @ 2.41GHz"
                        },
                        "memInfo": {
                            "totalMemMb": 3831.11,
                            "usedMemMb": 2439.89,
                            "freeMemMb": 1391.22,
                            "usedMemPercentage": 63.69,
                            "freeMemPercentage": 36.31
                        },
                        "driveInfo": {
                            "totalGb": "12.9",
                            "usedGb": "11.6",
                            "freeGb": "1.3",
                            "usedPercentage": "89.9",
                            "freePercentage": "10.1"
                        },
                        "netstatInfo": {
                            "total": {
                                "inputMb": 0.02,
                                "outputMb": 0.03
                            },
                            "enp1s0": {
                                "inputMb": 0.01,
                                "outputMb": 0.02
                            },
                            "wgc": {
                                "inputMb": 0,
                                "outputMb": 0
                            },
                            "wgp": {
                                "inputMb": 0.01,
                                "outputMb": 0.01
                            },
                            "br-cbd9d7451d72": {
                                "inputMb": 0,
                                "outputMb": 0
                            }
                        },
                        "osInfo": {
                            "type": "Linux",
                            "platform": "linux",
                            "release": "4.15.0-213-generic",
                            "ip": "10.0.9.10",
                            "hostname": "j1800",
                            "arch": "x64",
                            "uptime": 1619289.1
                        },
                        "openedCount": 0,
                        "ipInfo": {
                            "status": "success",
                            "country": "中国",
                            "countryCode": "CN",
                            "region": "GD",
                            "regionName": "广东",
                            "city": "广州市",
                            "zip": "",
                            "lat": 23.1181,
                            "lon": 113.2539,
                            "timezone": "Asia/Shanghai",
                            "isp": "Chinanet",
                            "org": "Chinanet GD",
                            "as": "AS4134 CHINANET-BACKBONE",
                            "query": "119.135.235.28"
                        },
                        "netInterface": {
                            12: [
                                {
                                    address: '10.0.9.12',
                                    netmask: '255.255.255.255',
                                    family: 'IPv4',
                                    mac: '00:00:00:00:00:00',
                                    internal: false,
                                    cidr: '10.0.9.12/32'
                                }
                            ],
                            client3: [
                                {
                                    address: '10.0.8.8',
                                    netmask: '255.255.255.255',
                                    family: 'IPv4',
                                    mac: '00:00:00:00:00:00',
                                    internal: false,
                                    cidr: '10.0.8.8/32'
                                }
                            ],
                            '以太网': [
                                {
                                    address: 'fe80::a490:1e42:43f2:fefc',
                                    netmask: 'ffff:ffff:ffff:ffff::',
                                    family: 'IPv6',
                                    mac: '00:2b:67:dd:5d:26',
                                    internal: false,
                                    cidr: 'fe80::a490:1e42:43f2:fefc/64',
                                    scopeid: 3
                                },
                                {
                                    address: '192.168.0.70',
                                    netmask: '255.255.255.0',
                                    family: 'IPv4',
                                    mac: '00:2b:67:dd:5d:26',
                                    internal: false,
                                    cidr: '192.168.0.70/24'
                                }
                            ],
                        }
                    }
                ],

                dict: {
                    "country": "国家",
                    "countryCode": "国家编码",
                    "regionName": "地区",
                    "city": "城市",
                    "lat": "纬度",
                    "lon": "经度",
                    "timezone": "时区",
                    "isp": "isp提供商",
                    "query": "真实ip",
                    "openedCount": "连接人数",
                    "type": "操作系统",
                    "platform": "平台",
                    "release": "版本",

                    "hostname": "主机名",
                    "arch": "cpu架构",
                    "uptime": "运行时间"
                },
                showIpv6: false,

            }
        },
        mounted() {
            /**
             * 连接成功
             * @param ev
             */
            ws.onopen = this.wsOpen;
            /**
             * 接收到消息
             * @param ev
             */
            ws.onmessage = this.wsMessage;
            ws.onclose = this.wsClose;
            ws.onerror = this.wsError;
        },
        computed: {},
        methods: {
            /**
             * 数据字典
             * @param k
             */
            dataMap(k) {
                return this.dict[k] ? this.dict[k] : k;
            },

            toFixed(value, count = 1) {
                value = Number(value)
                return isNaN(value) ? '--' : value.toFixed(count)
            },
            formatTime(second = 0) {
                let day = Math.floor(second / 60 / 60 / 24)
                let hour = Math.floor(second / 60 / 60 % 24)
                let minute = Math.floor(second / 60 % 60)
                return `${day}天${hour}时${minute}分`
            },
            formatNetSpeed(netSpeedMB) {
                netSpeedMB = Number(netSpeedMB) || 0
                if (netSpeedMB >= 1) return `${netSpeedMB.toFixed(2)} MB/s`
                return `${(netSpeedMB * 1024).toFixed(1)} KB/s`
            },

            formatTimestamp: (timestamp, format = 'time') => {
                if (typeof (timestamp) !== 'number') return '--'
                let date = new Date(timestamp)
                let padZero = (num) => String(num).padStart(2, '0')
                let year = date.getFullYear()
                let mounth = padZero(date.getMonth() + 1)
                let day = padZero(date.getDate())
                let hours = padZero(date.getHours())
                let minute = padZero(date.getMinutes())
                let second = padZero(date.getSeconds())
                switch (format) {
                    case 'date':
                        return `${year}-${mounth}-${day}`
                    case 'time':
                        return `${year}-${mounth}-${day} ${hours}:${minute}:${second}`
                    default:
                        return `${year}-${mounth}-${day} ${hours}:${minute}:${second}`
                }
            },

            formatMen(memSize) {
                if (memSize > 1024) {
                    return (memSize / 1024).toFixed(1) + 'GB';
                } else {
                    return memSize + 'MB';
                }

            },

            getStatus(progress) {

                if (progress > 70 && progress<90) {
                    return '#dfa238';
                } else if (progress > 90) {
                    return '#f34c4a';
                }

                return '#45a0ff';
            },

            wsOpen(ev) {
                console.log("连接打开")
            },
            wsClose(ev) {
                console.log("连接断开")
            },
            wsError(ev) {
                console.error(ev);
                console.log("连接异常，原因：" + JSON.stringify(ev))
            },
            wsMessage(ev) {
                let data = JSON.parse(ev.data);
                console.log(data)
                for (let i = 0; i < data.length; i++) {
                    data[i].osInfo.openedCount = data[i].openedCount;

                    delete data[i].ipInfo.status;
                    delete data[i].ipInfo.region;
                    delete data[i].ipInfo.zip;
                    delete data[i].ipInfo.org;
                    delete data[i].ipInfo.as;
                    delete data[i].osInfo.ip;


                    if (this.showIpv6 !== true) {
                        let keyArr = Object.keys(data[i].netInterface);
                        let obj = data[i].netInterface;
                        for (let j = 0; j < keyArr.length; j++) {

                            let key = keyArr[j];

                            let netinterfaceArr = obj[key];

                            obj[key] = netinterfaceArr.filter(function (item) {
                                return item.family === 'IPv4'
                            });


                            if (obj[key].length === 0) {
                                delete obj[key];
                            }
                        }


                    }
                }
                this.devList = data;
            },

            copy(str){
                let copyInput = document.createElement('input');//创建input元素
                document.body.appendChild(copyInput);//向页面底部追加输入框
                copyInput.setAttribute('value', str);//添加属性，将url赋值给input元素的value属性
                copyInput.select();//选择input元素
                document.execCommand("Copy");//执行复制命令
                this.$message({
                    message: "已复制"+str,
                    type: 'success',
                    duration:600
                });
                copyInput.remove();//删除动态创建的节点
            }
        }
    })
</script>

